{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">Admin Dashboard <small class="text-muted">Real-time OPD Operations</small></h2>

<div class="row">
    <!-- Main Chart -->
    <div class="col-md-8">
        <div class="card p-3 mb-4">
            <h5>Live Wait Time & Forecast</h5>
            <canvas id="forecastChart" height="150"></canvas>
        </div>

        <div class="card p-3">
            <h5>Peak Hour Analysis (Heatmap)</h5>
            <!-- Simple Table Heatmap for Prototype (Chart.js heatmap needs plugin) -->
            <div class="table-responsive">
                <table class="table table-bordered text-center table-sm" id="heatmap-table">
                    <thead>
                        <tr>
                            <th>Day</th>
                            {% for i in range(9, 18) %}
                            <th>{{ i }}:00</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="heatmap-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
        <div class="card p-3 border-danger mb-3">
            <h5 class="text-danger">Silent Alerts üö®</h5>
            <div id="alerts-container" style="max-height: 300px; overflow-y: auto;">
                <div class="text-center text-muted p-2">Loading logs...</div>
            </div>
        </div>

        <div class="card p-3 mb-3">
            <h5>Quick Actions</h5>
            <a href="/data-entry" class="btn btn-primary w-100 mb-2">Update Live Data</a>
            <a href="/upload-history" class="btn btn-outline-secondary w-100">Upload Historical CSV</a>
        </div>

        <div class="card p-3">
            <h5>System Health</h5>
            <div class="d-flex justify-content-between mb-2">
                <span>Anomaly Detection</span>
                <span class="text-success">‚óè Active</span>
            </div>
            <div class="d-flex justify-content-between">
                <span>Predictor Model</span>
                <span class="text-success">‚óè Trained (RandomForest)</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function loadDash() {
        // 1. Forecast Chart
        const ctx = document.getElementById('forecastChart').getContext('2d');
        const respForecast = await fetch('/api/analytics/forecast?department=General');
        const forecastData = await respForecast.json();

        // Take first 12 hours
        const labels = forecastData.slice(0, 12).map(d => d.time);
        const values = forecastData.slice(0, 12).map(d => d.wait_time);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Predicted Wait Time (min)',
                    data: values,
                    backgroundColor: values.map(v => v > 40 ? '#dc3545' : '#198754')
                }]
            }
        });

        // 2. Heatmap
        const respHeatmap = await fetch('/api/analytics/heatmap');
        const heatData = await respHeatmap.json(); // Array of Day Objects
        const tbody = document.getElementById('heatmap-body');
        tbody.innerHTML = '';

        heatData.forEach(day => {
            const tr = document.createElement('tr');
            let html = `<th>${day.name}</th>`;

            day.data.forEach(slot => {
                // Color based on intensity
                let color = '#d1e7dd'; // low
                if (slot.y > 50) color = '#fff3cd'; // med
                if (slot.y > 80) color = '#f8d7da'; // high
                html += `<td style="background-color: ${color}; font-size: 0.8rem;">${slot.y}%</td>`;
            });
            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        // 3. Alerts
        const respAlerts = await fetch('/api/alerts');
        const alerts = await respAlerts.json();
        const alertCont = document.getElementById('alerts-container');
        alertCont.innerHTML = '';

        if (alerts.length === 0) {
            alertCont.innerHTML = '<p class="text-muted text-center">No logic stats.</p>';
        } else {
            alerts.forEach(a => {
                const item = document.createElement('div');
                item.className = 'alert alert-light border mb-2';
                item.innerHTML = `
                    <strong>${a.issue_type}</strong> <span class="badge bg-danger">${a.severity}</span><br>
                    <small>${a.description}</small><br>
                    <small class="text-muted">${new Date(a.timestamp).toLocaleTimeString()}</small>
                `;
                alertCont.appendChild(item);
            });
        }
    }

    loadDash();
    setInterval(loadDash, 30000); // Refresh every 30s
</script>
{% endblock %}